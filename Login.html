<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="https://i.imgur.com/E4FIiRK.png">
  <title>Login - NumSphere</title>
  <!-- Start cookieyes banner --> <script id="cookieyes" type="text/javascript" src="https://cdn-cookieyes.com/client_data/217794c202a597d4183fff87/script.js"></script> <!-- End cookieyes banner -->
<!-- Google Analytics (with CookieYes consent control) -->
<script type="text/plain" cookie-consent="analytics" async src="https://www.googletagmanager.com/gtag/js?id=G-1V9JH211J0"></script>

<script type="text/plain" cookie-consent="analytics">
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1V9JH211J0', { 'anonymize_ip': true });
</script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: white;
      color: #151515;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      position: relative;
    }
    .login-container {
      background: #ffffff;
      padding: 3rem 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 100%;
      max-width: 400px;
      z-index: 1;
    }
    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: 700;
      color: #151515;
      margin-bottom: 1rem;
      text-decoration: none;
    }
    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #4263eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }
    .logo-inner {
      width: 14px;
      height: 14px;
      border: 2px solid white;
      border-radius: 50%;
    }
    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #151515;
      margin-bottom: 0.5rem;
    }
    .page-subtitle {
      color: #666;
      margin-bottom: 2rem;
      font-size: 0.9rem;
    }
    input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background-color: #4263eb;
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 1rem;
    }
    button:hover {
      background-color: #2f4bcf;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .secondary-btn {
      background-color: #6c757d;
    }
    .secondary-btn:hover {
      background-color: #5a6268;
    }
    .animated-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      z-index: 0;
    }
    .circle {
      position: absolute;
      border-radius: 50%;
      background: rgba(66, 99, 235, 0.15);
      animation: float 10s ease-in-out infinite;
    }
    .circle:nth-child(1) {
      width: 200px;
      height: 200px;
      top: 10%;
      left: 5%;
    }
    .circle:nth-child(2) {
      width: 150px;
      height: 150px;
      bottom: 10%;
      right: 10%;
    }
    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-20px);
      }
    }
    .alert {
      padding: 0.75rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .alert-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .loading {
      display: none;
    }
    .loading.show {
      display: inline-block;
      margin-left: 8px;
    }
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #4263eb;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .forgot-password {
      color: #4263eb;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .forgot-password:hover {
      text-decoration: underline;
    }
    .security-notice {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      font-size: 0.8rem;
      color: #6c757d;
    }
    .cooldown-timer {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #856404;
      font-weight: 600;
    }
    .reset-suggestion {
      background: #e7f3ff;
      border: 1px solid #4263eb;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      color: #0c5460;
      font-size: 0.9rem;
    }
    .reset-suggestion a {
      color: #4263eb;
      text-decoration: none;
      font-weight: 600;
    }
    .reset-suggestion a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="animated-bg">
    <div class="circle"></div>
    <div class="circle"></div>
  </div>
  <div class="login-container">
    <a href="index.html" class="logo">
      <div class="logo-circle">
        <div class="logo-inner"></div>
      </div>
      NumSphere
    </a>

    <div class="page-title">Welcome Back</div>
    <div class="page-subtitle">Sign in to your NumSphere account</div>

    <div id="alertContainer"></div>
    <div id="cooldownTimer" class="cooldown-timer" style="display: none;"></div>

    <form id="loginForm">
      <input type="email" id="email" placeholder="Email Address" required autocomplete="email" />
      <input type="password" id="password" placeholder="Password" required autocomplete="current-password" />

      <button type="submit" id="loginBtn">
        Sign In
        <span class="loading" id="loadingSpinner">
          <span class="spinner"></span>
        </span>
      </button>
    </form>

    <div style="margin: 1rem 0;">
      <a href="ResetPassword.html" class="forgot-password">Forgot your password?</a>
    </div>

    <button type="button" class="secondary-btn" onclick="goHome()">Back to Home</button>

    <div id="resetSuggestion" class="reset-suggestion" style="display: none;">
      🔓 For immediate access, you can <a href="ResetPassword.html">reset your password</a> or wait for the lockout to expire.
    </div>

    <div class="security-notice">
      🔒 Your account is protected by advanced security measures. Multiple failed login attempts will result in temporary account lockout.
    </div>
  </div>

<script>
    const GOOGLE_APPS_SCRIPT_URL = 'https://numsphere-proxy.onrender.com';
    
    // Server-side lockout tracking
    let isBlocked = false;
    let blockEndTime = null;
    
    // Update cooldown timer display (server enforced - 6 minutes)
    function updateCooldownTimer(endTime) {
        const timer = document.getElementById('cooldownTimer');
        const loginBtn = document.getElementById('loginBtn');
        const resetSuggestion = document.getElementById('resetSuggestion');
        
        const updateDisplay = () => {
            const now = Date.now();
            const remaining = endTime - now;
            
            if (remaining <= 0) {
                timer.style.display = 'none';
                resetSuggestion.style.display = 'none';
                loginBtn.disabled = false;
                isBlocked = false;
                blockEndTime = null;
                return;
            }
            
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            timer.innerHTML = `
                ⏱️ Login temporarily disabled. Try again in ${minutes}m ${seconds}s
                <br><small>This is a security measure to protect your account.</small>
            `;
            timer.style.display = 'block';
            resetSuggestion.style.display = 'block';
            loginBtn.disabled = true;
            isBlocked = true;
            blockEndTime = endTime;
            
            setTimeout(updateDisplay, 1000);
        };
        
        updateDisplay();
    }

    // Show alert messages
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        
        // Auto-hide success messages
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
    }

    // Email validation
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Set loading state
    function setLoadingState(loading) {
        const loginBtn = document.getElementById('loginBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        if (loading) {
            loginBtn.disabled = true;
            loadingSpinner.classList.add('show');
        } else {
            loginBtn.disabled = isBlocked; // Only enable if not blocked by server
            loadingSpinner.classList.remove('show');
        }
    }

    function goHome() {
        window.location.href = 'index.html';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const alertContainer = document.getElementById('alertContainer');

        loginForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Check if blocked by server
            if (isBlocked && blockEndTime && Date.now() < blockEndTime) {
                showAlert('Please wait for the cooldown period to end or reset your password for immediate access.', 'warning');
                return;
            }

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showAlert('Please enter both email and password', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                showAlert('Please enter a valid email address', 'error');
                return;
            }

            setLoadingState(true);

            try {
                console.log('Attempting login for:', email);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'login',
                        email: email,
                        password: password
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    // Handle different HTTP status codes
                    if (response.status === 429) {
                        throw new Error('Too many requests. Please try again later.');
                    } else if (response.status === 403) {
                        throw new Error('Access denied. Please try again later.');
                    } else {
                        throw new Error(`Server error (${response.status}). Please try again.`);
                    }
                }

                const result = await response.json();
                console.log('Login result:', result);

                // Handle server-side rate limiting/blocking
                if (result.rateLimited || result.blocked) {
                    // Server enforces 6-minute lockout, so we calculate based on that
                    const cooldownEnd = Date.now() + (6 * 60 * 60 * 1000); // 6 minutes
                    updateCooldownTimer(cooldownEnd);
                    showAlert(result.message || 'Too many attempts. Ip Has Been Blocked any login request will be blocked for current time any other login for another account will be denied Please try again later.', 'error');
                    return;
                }

                if (result.success) {
                    // Store user data
                    sessionStorage.setItem('userEmail', email);
                    sessionStorage.setItem('isAuthenticated', 'true');
                    
                    if (result.user) {
                        sessionStorage.setItem('userName', result.user.fullName || '');
                        sessionStorage.setItem('userPhone', result.user.assignedNumber || '');
                        sessionStorage.setItem('userPlan', result.user.plan || '');
                    }

                    if (result.requirePasswordChange) {
                        sessionStorage.setItem('tempLogin', 'true');
                        showAlert('Login successful! You must change your temporary password.', 'info');
                        setTimeout(() => {
                            window.location.href = 'ResetPassword.html';
                        }, 2000);
                    } else {
                       showAlert('Login successful! Redirecting...', 'success');
                       setTimeout(() => {
                          window.location.href = 'Loading.html';
                       }, 1500);
                    }
                } else {
                    // Server handles failed login tracking and provides attempt count
                    let message = result.message || 'Login failed. Please check your credentials.';
                    
                    // Check if message includes attempt count info
                    if (message.includes('attempts remaining')) {
                        showAlert(message + ' For immediate access, you can reset your password.', 'warning');
                    } else {
                        showAlert(message, 'error');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                
                if (error.name === 'AbortError') {
                    showAlert('Request timed out. Please check your connection and try again.', 'error');
                } else {
                    showAlert(error.message || 'Network error. Please try again.', 'error');
                }
            } finally {
                setLoadingState(false);
            }
        });

        // Prevent form submission while blocked
        loginForm.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (isBlocked || loginBtn.disabled)) {
                e.preventDefault();
                return false;
            }
        });

        // Clear alerts when user starts typing
        emailInput.addEventListener('input', () => {
            if (alertContainer.innerHTML) {
                alertContainer.innerHTML = '';
            }
        });

        passwordInput.addEventListener('input', () => {
            if (alertContainer.innerHTML) {
                alertContainer.innerHTML = '';
            }
        });
    });
</script>
</body>
</html>
