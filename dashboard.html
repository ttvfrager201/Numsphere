
<script>
// Check authentication before page loads
(function() {
  'use strict';
  
  // Check if user is logged in
  function checkAuthentication() {
    const userLoggedIn = sessionStorage.getItem('userLoggedIn');
    const userEmail = sessionStorage.getItem('userEmail');
    
    if (!userLoggedIn || userLoggedIn !== 'true' || !userEmail) {
      // User not logged in, redirect to login
      alert('Please login to access the dashboard.');
      window.location.href = 'Login.html';
      return false;
    }
    
    return true;
  }
  
  // Check if user completed password change (if it was required)
  function checkPasswordChange() {
    const passwordChanged = sessionStorage.getItem('passwordChanged');
    const userEmail = sessionStorage.getItem('userEmail');
    
    // If user logged in but hasn't changed password when required
    if (userEmail && (!passwordChanged || passwordChanged !== 'true')) {
      // Check if they need to change password by calling the server
      // For now, assume they're good if they reached dashboard
      sessionStorage.setItem('passwordChanged', 'true');
    }
  }
  
  // Initialize dashboard security
  function initDashboardSecurity() {
    if (!checkAuthentication()) {
      return; // Will redirect to login
    }
    
    checkPasswordChange();
    
    // Display user info
    const userName = sessionStorage.getItem('userName');
    const userPhone = sessionStorage.getItem('userPhone');
    
    console.log('âœ… Dashboard access granted for:', userName);
    
    // You can set user info in dashboard elements here
    document.addEventListener('DOMContentLoaded', function() {
      // Update dashboard with user info
      const userNameElements = document.querySelectorAll('.user-name');
      const userPhoneElements = document.querySelectorAll('.user-phone');
      
      userNameElements.forEach(el => {
        if (userName) el.textContent = userName;
      });
      
      userPhoneElements.forEach(el => {
        if (userPhone) el.textContent = userPhone;
      });
    });
  }
  
  // Logout function
  window.logoutUser = function() {
    if (confirm('Are you sure you want to logout?')) {
      // Clear session
      sessionStorage.clear();
      
      // Redirect to login
      window.location.href = 'Login.html';
    }
  };
  
  // Session timeout (optional - 30 minutes)
  let sessionTimeout;
  
  function resetSessionTimeout() {
    clearTimeout(sessionTimeout);
    sessionTimeout = setTimeout(function() {
      alert('Your session has expired. Please login again.');
      logoutUser();
    }, 30 * 60 * 1000); // 30 minutes
  }
  
  // Reset timeout on user activity
  document.addEventListener('click', resetSessionTimeout);
  document.addEventListener('keypress', resetSessionTimeout);
  document.addEventListener('scroll', resetSessionTimeout);
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDashboardSecurity);
  } else {
    initDashboardSecurity();
  }
  
  // Start session timeout
  resetSessionTimeout();
  
})();
</script>
